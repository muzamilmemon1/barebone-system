image: node:18.20.4

stages:          
  - build
  - test
  - deploy

build-job:       
  stage: build
  script:
    - yarn install
    - yarn build
  artifacts:
    paths: 
      - build/

cypress-test-job:    
  image: cypress/browsers:node-18.20.3-chrome-125.0.6422.141-1-ff-126.0.1-edge-125.0.2535.85-1
  stage: test    
  script:
    - yarn install
    - yarn dev &  
    - yarn cy:run  
  artifacts:
    when: always
    paths:
      - cypress/videos/**/*.mp4
      - cypress/screenshots/**/*.png
    expire_in: 1 week
  allow_failure: false

deploy-job:      
  stage: deploy  
  script:
    - yarn global add vercel
    - vercel --prod --token $VERCEL_TOKEN
  only:
    - master  
  dependencies:   
    - build-job
    - cypress-test-job
  environment:
    name: production
    url: https://barebone-system.vercel.app
  when: on_success