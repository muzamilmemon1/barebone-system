image: node:18.20.4  # Using Node 18.20.4 as the base image for all jobs

stages:
  - build
  - test
  - stop
  - deploy

# Build job
build-job:
  stage: build
  script:
    - yarn install --frozen-lockfile
    - yarn build
  artifacts:
    paths:
      - build/

# Cypress testing job
cypress-test-job:
  image: cypress/browsers:node-18.20.3-chrome-125.0.6422.141-1-ff-126.0.1-edge-125.0.2535.85-1
  stage: test
  script:
    - yarn install --frozen-lockfile
    - yarn cy:test
  artifacts:
    when: always
    paths:
      - cypress/videos/**/*.mp4
      - cypress/screenshots/**/*.png
    expire_in: 1 week
  dependencies:
    - build-job
  timeout: 10m
  allow_failure: false

# Stop job
stop-job:
  stage: stop
  script:
    - echo "Stopping the pipeline due to test failure"
  when: on_failure

# Deploy job using the variable for Vercel Deploy Hook URL
deploy-job:
  stage: deploy
  script:
    - curl -X POST https://api.vercel.com/v1/integrations/deploy/prj_Aq7jiV52lGaGwaXYYnbzrG25539Y/hfoQrwZS8E
  only:
    - master
  environment: production
  when: on_success
  dependencies:
    - build-job
    - cypress-test-job